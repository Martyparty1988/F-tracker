<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finance PWA</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">
    
    <style>
        :root {
            --ios-gray-bg: #f2f2f7;
            --ios-white: #ffffff;
            --ios-blue: #007aff;
            --ios-green: #34c759;
            --ios-red: #ff3b30;
            --ios-gray-text: #8e8e93;
            --ios-separator: #c6c6c8;
            --ios-radius: 12px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--ios-gray-bg);
            color: #000;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- LAYOUT --- */
        .app-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: calc(var(--safe-top) + 20px);
            padding-bottom: calc(80px + var(--safe-bottom)); /* Space for tabbar */
            padding-left: 16px;
            padding-right: 16px;
        }

        .view { display: none; animation: fadeIn 0.2s ease-in-out; }
        .view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTS --- */
        h1 { font-size: 34px; font-weight: 700; margin: 0 0 20px 0; letter-spacing: -0.5px; }
        h2 { font-size: 20px; font-weight: 600; margin: 24px 0 10px 0; color: #1c1c1e; }
        
        .card {
            background: var(--ios-white);
            border-radius: var(--ios-radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .row { display: flex; justify-content: space-between; align-items: center; }
        .col { display: flex; flex-direction: column; }
        
        /* Balance Card */
        .balance-card { text-align: center; padding: 24px 16px; }
        .balance-label { font-size: 13px; color: var(--ios-gray-text); text-transform: uppercase; letter-spacing: 0.5px; }
        .balance-amount { font-size: 40px; font-weight: 700; margin: 8px 0; letter-spacing: -1px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-item { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { display: block; font-weight: 600; font-size: 15px; }
        .stat-lbl { font-size: 11px; color: var(--ios-gray-text); }
        .text-green { color: var(--ios-green); }
        .text-red { color: var(--ios-red); }

        /* List Items */
        .list-group { background: var(--ios-white); border-radius: var(--ios-radius); overflow: hidden; }
        .list-item {
            display: flex; align-items: center;
            padding: 12px 16px;
            border-bottom: 0.5px solid var(--ios-separator);
            cursor: pointer;
            transition: background 0.1s;
        }
        .list-item:active { background: #f2f2f7; }
        .list-item:last-child { border-bottom: none; }
        
        .icon-box {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-right: 12px; flex-shrink: 0;
        }
        .icon-income { background: rgba(52, 199, 89, 0.15); color: var(--ios-green); }
        .icon-expense { background: rgba(255, 59, 48, 0.15); color: var(--ios-red); }
        
        .item-content { flex: 1; min-width: 0; }
        .item-title { font-weight: 600; font-size: 16px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 13px; color: var(--ios-gray-text); }
        .item-amount { font-weight: 600; font-size: 16px; margin-left: 10px; white-space: nowrap; }

        .badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; 
            background: #e5e5ea; color: #8e8e93; margin-left: 6px; vertical-align: middle;
        }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px;
            width: 56px; height: 56px; border-radius: 28px;
            background: var(--ios-blue); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,122,255,0.4);
            font-size: 28px; cursor: pointer; z-index: 100;
        }

        /* --- TAB BAR --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(60px + var(--safe-bottom));
            background: rgba(249, 249, 249, 0.94);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.2);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 90;
        }
        .tab-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #999; font-size: 10px; padding-top: 8px; cursor: pointer;
        }
        .tab-btn.active { color: var(--ios-blue); }
        .tab-icon { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 200;
            display: none; justify-content: center; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-sheet {
            background: var(--ios-gray-bg);
            width: 100%; max-width: 600px;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            height: 92dvh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        
        .modal-header {
            padding: 16px; background: var(--ios-white); 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10; border-bottom: 0.5px solid var(--ios-separator);
        }
        .btn-text { font-size: 17px; color: var(--ios-blue); background: none; border: none; cursor: pointer; padding: 0; }
        .btn-text.danger { color: var(--ios-red); }

        /* Form */
        .form-section { background: var(--ios-white); margin-top: 20px; border-radius: var(--ios-radius); overflow: hidden; margin: 20px 16px; }
        .input-row {
            display: flex; align-items: center;
            padding: 12px 16px; border-bottom: 0.5px solid var(--ios-separator);
        }
        .input-row:last-child { border-bottom: none; }
        .input-label { width: 100px; font-size: 16px; }
        .input-field {
            flex: 1; border: none; font-size: 16px; background: transparent; 
            text-align: right; color: #000; outline: none; font-family: inherit;
        }
        .segment-control {
            display: flex; background: #e5e5ea; padding: 2px; border-radius: 8px; width: 100%; margin-bottom: 10px;
        }
        .segment-btn {
            flex: 1; text-align: center; padding: 6px; font-size: 14px; border-radius: 6px; cursor: pointer;
        }
        .segment-btn.active { background: white; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Stats Bars */
        .bar-container { margin-bottom: 12px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px; }
        .bar-bg { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--ios-blue); }

        /* Filters */
        .filter-bar {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 10px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .filter-chip {
            padding: 6px 12px; background: #e5e5ea; border-radius: 16px; font-size: 14px; white-space: nowrap; cursor: pointer;
        }
        .filter-chip.active { background: var(--ios-blue); color: white; }

        /* Empty State */
        .empty-state { text-align: center; color: var(--ios-gray-text); margin-top: 50px; }
    </style>
</head>
<body>

    <!-- Views -->
    <div id="app-container" class="app-container">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view active">
            <h1>P≈ôehled</h1>
            
            <div class="card balance-card">
                <div class="balance-label">Aktu√°ln√≠ z≈Østatek</div>
                <div class="balance-amount" id="dash-balance">0,00 ‚Ç¨</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-val text-green" id="dash-inc">0 ‚Ç¨</span>
                        <span class="stat-lbl">P≈ô√≠jmy</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val text-red" id="dash-exp">0 ‚Ç¨</span>
                        <span class="stat-lbl">V√Ωdaje</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-val" id="dash-net">0 ‚Ç¨</span>
                        <span class="stat-lbl">ƒåist√© (Mƒõs√≠c)</span>
                    </div>
                </div>
            </div>

            <h2>Posledn√≠ z√°znamy</h2>
            <div class="list-group" id="dash-list">
                <!-- Items here -->
            </div>
            <div class="empty-state" id="dash-empty" style="display:none;">≈Ω√°dn√© z√°znamy</div>
        </div>

        <!-- RECORDS (LIST) -->
        <div id="view-records" class="view">
            <h1>Z√°znamy</h1>
            
            <div style="padding: 0 4px 10px 4px;">
                <input type="text" id="search-input" placeholder="Hledat..." 
                       style="width: 100%; padding: 10px; border-radius: 10px; border: none; background: #e5e5ea; font-size: 16px;">
            </div>

            <div class="filter-bar">
                <div class="filter-chip active" data-filter="all">V≈°e</div>
                <div class="filter-chip" data-filter="income">P≈ô√≠jmy</div>
                <div class="filter-chip" data-filter="expense">V√Ωdaje</div>
                <div class="filter-chip" data-filter="payout">V√Ωplata</div>
            </div>

            <div class="list-group" id="records-list">
                <!-- Items here -->
            </div>
        </div>

        <!-- STATS -->
        <div id="view-stats" class="view">
            <h1>Statistiky</h1>
            <p style="color:var(--ios-gray-text); font-size:14px; margin-bottom: 20px;">Tento mƒõs√≠c</p>
            
            <div class="card">
                <div id="stats-bars"></div>
            </div>

            <h2>Top Zdroje</h2>
            <div class="card" id="stats-sources"></div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="view">
            <h1>Nastaven√≠</h1>
            <div class="list-group">
                <div class="list-item" onclick="app.exportData()">
                    <div class="item-content">Z√°lohovat data (JSON)</div>
                </div>
                <div class="list-item" style="position:relative;">
                    <input type="file" id="import-file" style="position:absolute; width:100%; height:100%; opacity:0; left:0; top:0;" accept=".json">
                    <div class="item-content">Obnovit data (Import)</div>
                </div>
                <div class="list-item" onclick="app.resetData()">
                    <div class="item-content text-red">Vymazat v≈°echna data</div>
                </div>
            </div>
            <p style="text-align:center; color: #999; font-size: 12px; margin-top: 30px;">
                Verze 1.0 (Offline PWA)<br>Ulo≈æeno v prohl√≠≈æeƒçi
            </p>
        </div>

    </div>

    <!-- Floating Action Button -->
    <div class="fab" onclick="modal.open()">+</div>

    <!-- Bottom Navigation -->
    <nav class="tab-bar">
        <div class="tab-btn active" onclick="nav.to('dashboard')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>P≈ôehled</span>
        </div>
        <div class="tab-btn" onclick="nav.to('records')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            <span>Z√°znamy</span>
        </div>
        <div class="tab-btn" onclick="nav.to('stats')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            <span>Statistiky</span>
        </div>
        <div class="tab-btn" onclick="nav.to('settings')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <span>Nastaven√≠</span>
        </div>
    </nav>

    <!-- Modal (Add/Edit) -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-sheet">
            <div class="modal-header">
                <button class="btn-text" onclick="modal.close()">Zru≈°it</button>
                <b id="modal-title">Nov√Ω z√°znam</b>
                <button class="btn-text" style="font-weight:600" onclick="modal.save()">Ulo≈æit</button>
            </div>
            
            <div style="padding: 20px 16px 0 16px;">
                <div class="segment-control" id="type-segment">
                    <div class="segment-btn active" onclick="modal.setType('income')" data-val="income">P≈ô√≠jem</div>
                    <div class="segment-btn" onclick="modal.setType('expense')" data-val="expense">V√Ωdaj</div>
                    <div class="segment-btn" onclick="modal.setType('payout')" data-val="payout">V√Ωplata</div>
                </div>
            </div>

            <div class="form-section">
                <div class="input-row">
                    <label class="input-label">ƒå√°stka</label>
                    <input type="number" id="inp-amount" class="input-field" placeholder="0" inputmode="decimal">
                    <span style="margin-left:5px">‚Ç¨</span>
                </div>
                <div class="input-row">
                    <label class="input-label">Datum</label>
                    <input type="date" id="inp-date" class="input-field">
                </div>
            </div>

            <div class="form-section">
                <div class="input-row">
                    <label class="input-label">Kategorie</label>
                    <input type="text" id="inp-cat" class="input-field" placeholder="Nap≈ô. J√≠dlo" list="cat-suggestions">
                    <datalist id="cat-suggestions">
                        <option value="J√≠dlo">
                        <option value="V√Ωplata">
                        <option value="Auto">
                        <option value="N√°kupy">
                        <option value="Bydlen√≠">
                    </datalist>
                </div>
                <div class="input-row">
                    <label class="input-label">Zdroj/Kdo</label>
                    <input type="text" id="inp-source" class="input-field" placeholder="Nap≈ô. Honza">
                </div>
                <div class="input-row">
                    <label class="input-label">Forma</label>
                    <select id="inp-method" class="input-field" dir="rtl">
                        <option value="bank">Banka / Karta</option>
                        <option value="cash">Hotovost</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="input-row">
                    <label class="input-label">Pozn√°mka</label>
                    <input type="text" id="inp-note" class="input-field" placeholder="Voliteln√©">
                </div>
                <div class="input-row" style="justify-content: space-between;">
                    <label class="input-label">Hotovo</label>
                    <input type="checkbox" id="inp-done" style="transform: scale(1.5);">
                </div>
            </div>

            <div style="padding: 20px 16px 50px 16px;">
                <button id="btn-delete" class="btn-text danger" style="width:100%; text-align:center; padding:15px; background:white; border-radius:12px; display:none;" onclick="modal.delete()">Smazat z√°znam</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- UTILS ---
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const formatMoney = (amount) => new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'EUR' }).format(amount);
        const todayStr = () => new Date().toISOString().split('T')[0];
        
        // --- DB LAYER (IndexedDB) ---
        const DB = {
            dbName: 'FinanceAppDB',
            version: 1,
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('records')) {
                            const store = db.createObjectStore('records', { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e);
                });
            },

            async getAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction('records', 'readonly');
                    const store = tx.objectStore('records');
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve([]); // Fallback
                });
            },

            async save(record) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction('records', 'readwrite');
                    tx.objectStore('records').put(record);
                    tx.oncomplete = () => resolve(record);
                });
            },

            async delete(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction('records', 'readwrite');
                    tx.objectStore('records').delete(id);
                    tx.oncomplete = () => resolve();
                });
            },
            
            async clear() {
                return new Promise(resolve => {
                    const tx = this.db.transaction('records', 'readwrite');
                    tx.objectStore('records').clear();
                    tx.oncomplete = () => resolve();
                });
            }
        };

        // --- STATE & APP LOGIC ---
        const app = {
            data: [],
            filter: { type: 'all', search: '' },

            async init() {
                try {
                    await DB.init();
                    await this.loadData();
                    nav.to('dashboard');
                } catch (e) {
                    alert('Chyba datab√°ze: ' + e);
                }
            },

            async loadData() {
                this.data = await DB.getAll();
                // Sort by date desc
                this.data.sort((a, b) => new Date(b.date) - new Date(a.date) || b.createdAt - a.createdAt);
                ui.renderDashboard();
                ui.renderList();
                ui.renderStats();
            },

            async addRecord(record) {
                record.id = record.id || uuid();
                record.createdAt = record.createdAt || Date.now();
                record.updatedAt = Date.now();
                await DB.save(record);
                await this.loadData();
            },

            async deleteRecord(id) {
                if(confirm('Opravdu smazat?')) {
                    await DB.delete(id);
                    await this.loadData();
                    modal.close();
                }
            },

            exportData() {
                const blob = new Blob([JSON.stringify(this.data, null, 2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance_backup_${todayStr()}.json`;
                a.click();
            },

            async importData(jsonString) {
                try {
                    const imported = JSON.parse(jsonString);
                    if (!Array.isArray(imported)) throw new Error("Neplatn√Ω form√°t");
                    
                    // Basic validation
                    if(imported.length > 0 && !imported[0].type) throw new Error("Neplatn√° data");

                    await DB.clear();
                    for (const rec of imported) {
                        await DB.save(rec);
                    }
                    await this.loadData();
                    alert('Import dokonƒçen!');
                } catch (e) {
                    alert('Chyba importu: ' + e.message);
                }
            },

            async resetData() {
                if(confirm('Opravdu smazat v≈°echna data? Tuto akci nelze vz√≠t zpƒõt.')) {
                    await DB.clear();
                    await this.loadData();
                }
            }
        };

        // --- UI CONTROLLER ---
        const ui = {
            renderDashboard() {
                // Balance calc
                let balance = 0, inc = 0, exp = 0;
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM

                this.data.forEach(r => {
                    const val = parseFloat(r.amount);
                    if (r.type === 'expense') {
                        balance -= val;
                        if (r.date.startsWith(currentMonth)) exp += val;
                    } else {
                        balance += val;
                        if (r.date.startsWith(currentMonth)) inc += val;
                    }
                });

                document.getElementById('dash-balance').textContent = formatMoney(balance);
                document.getElementById('dash-inc').textContent = formatMoney(inc);
                document.getElementById('dash-exp').textContent = formatMoney(exp);
                document.getElementById('dash-net').textContent = formatMoney(inc - exp);

                // Recent 5
                const listEl = document.getElementById('dash-list');
                const emptyEl = document.getElementById('dash-empty');
                listEl.innerHTML = '';
                
                const recent = app.data.slice(0, 5);
                if (recent.length === 0) {
                    emptyEl.style.display = 'block';
                } else {
                    emptyEl.style.display = 'none';
                    recent.forEach(r => listEl.appendChild(this.createRow(r)));
                }
            },

            renderList() {
                const listEl = document.getElementById('records-list');
                listEl.innerHTML = '';
                
                const term = app.filter.search.toLowerCase();
                const type = app.filter.type;

                const filtered = app.data.filter(r => {
                    const matchesType = type === 'all' || r.type === type;
                    const matchesSearch = (r.note + r.category + r.source).toLowerCase().includes(term);
                    return matchesType && matchesSearch;
                });

                filtered.forEach(r => listEl.appendChild(this.createRow(r)));
            },

            renderStats() {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthData = app.data.filter(r => r.date.startsWith(currentMonth));
                
                // Group by Category (Expenses only)
                const cats = {};
                const sources = {};
                let totalExp = 0;

                monthData.forEach(r => {
                    if (r.type === 'expense') {
                        const c = r.category || 'Neza≈ôazeno';
                        cats[c] = (cats[c] || 0) + r.amount;
                        totalExp += r.amount;
                    } else {
                        const s = r.source || 'Nezn√°m√Ω';
                        sources[s] = (sources[s] || 0) + r.amount;
                    }
                });

                // Render Bars
                const barsEl = document.getElementById('stats-bars');
                barsEl.innerHTML = '';
                
                if (totalExp === 0) {
                    barsEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999">≈Ω√°dn√© v√Ωdaje tento mƒõs√≠c</div>';
                } else {
                    Object.entries(cats)
                        .sort((a,b) => b[1] - a[1])
                        .forEach(([name, val]) => {
                            const pct = (val / totalExp) * 100;
                            barsEl.innerHTML += `
                                <div class="bar-container">
                                    <div class="bar-label"><span>${name}</span><span>${formatMoney(val)}</span></div>
                                    <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
                                </div>`;
                        });
                }

                // Render Sources
                const srcEl = document.getElementById('stats-sources');
                srcEl.innerHTML = '';
                Object.entries(sources).sort((a,b) => b[1] - a[1]).slice(0, 5).forEach(([name, val]) => {
                    srcEl.innerHTML += `
                        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:0.5px solid #eee;">
                            <span>${name}</span>
                            <b>${formatMoney(val)}</b>
                        </div>`;
                });
            },

            createRow(r) {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.onclick = () => modal.edit(r);
                
                const isExp = r.type === 'expense';
                const sign = isExp ? '-' : '+';
                const colorClass = isExp ? 'text-red' : 'text-green';
                const iconClass = isExp ? 'icon-expense' : 'icon-income';
                const iconChar = r.type === 'payout' ? 'üí∞' : (isExp ? 'üìâ' : 'üìà');
                const badge = r.isDone ? '‚úÖ' : '';
                const methodBadge = `<span class="badge">${r.method === 'cash' ? 'Cash' : 'Bank'}</span>`;

                el.innerHTML = `
                    <div class="icon-box ${iconClass}">${iconChar}</div>
                    <div class="item-content">
                        <div class="item-title">${r.category || r.source || 'Bez n√°zvu'} ${badge}</div>
                        <div class="item-meta">${r.date} ‚Ä¢ ${r.note || r.source} ${methodBadge}</div>
                    </div>
                    <div class="item-amount ${colorClass}">${sign}${formatMoney(r.amount)}</div>
                `;
                return el;
            }
        };

        // --- NAVIGATION ---
        const nav = {
            to(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById('view-' + viewId).classList.add('active');
                
                // Find tab index logic simplified
                const tabs = ['dashboard', 'records', 'stats', 'settings'];
                const idx = tabs.indexOf(viewId);
                if(idx !== -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
                
                if (viewId === 'records') ui.renderList();
                if (viewId === 'stats') ui.renderStats();
            }
        };

        // --- MODAL LOGIC ---
        const modal = {
            currentId: null,
            
            open() {
                this.resetForm();
                this.currentId = null;
                document.getElementById('modal-title').textContent = 'Nov√Ω z√°znam';
                document.getElementById('btn-delete').style.display = 'none';
                document.getElementById('modal-overlay').classList.add('open');
            },
            
            edit(r) {
                this.currentId = r.id;
                document.getElementById('modal-title').textContent = 'Upravit z√°znam';
                document.getElementById('inp-amount').value = r.amount;
                document.getElementById('inp-date').value = r.date;
                document.getElementById('inp-cat').value = r.category || '';
                document.getElementById('inp-source').value = r.source || '';
                document.getElementById('inp-note').value = r.note || '';
                document.getElementById('inp-method').value = r.method;
                document.getElementById('inp-done').checked = r.isDone;
                this.setType(r.type);
                
                document.getElementById('btn-delete').style.display = 'block';
                document.getElementById('modal-overlay').classList.add('open');
            },

            close() {
                document.getElementById('modal-overlay').classList.remove('open');
            },

            setType(type) {
                document.querySelectorAll('.segment-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.val === type);
                });
            },

            resetForm() {
                document.getElementById('inp-amount').value = '';
                document.getElementById('inp-date').value = todayStr();
                document.getElementById('inp-cat').value = '';
                document.getElementById('inp-source').value = '';
                document.getElementById('inp-note').value = '';
                document.getElementById('inp-method').value = 'bank';
                document.getElementById('inp-done').checked = false;
                this.setType('income');
            },

            async save() {
                const amount = parseFloat(document.getElementById('inp-amount').value);
                if (!amount || amount <= 0) return alert('Zadejte platnou ƒç√°stku');

                const type = document.querySelector('.segment-btn.active').dataset.val;
                
                const record = {
                    id: this.currentId,
                    type: type,
                    amount: amount,
                    currency: 'EUR',
                    date: document.getElementById('inp-date').value,
                    category: document.getElementById('inp-cat').value,
                    source: document.getElementById('inp-source').value,
                    note: document.getElementById('inp-note').value,
                    method: document.getElementById('inp-method').value,
                    isDone: document.getElementById('inp-done').checked
                };

                await app.addRecord(record);
                this.close();
            },

            delete() {
                if (this.currentId) app.deleteRecord(this.currentId);
            }
        };

        // --- EVENT LISTENERS ---
        // Filter chips
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                app.filter.type = chip.dataset.filter;
                ui.renderList();
            });
        });

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            app.filter.search = e.target.value;
            ui.renderList();
        });

        // Import
        document.getElementById('import-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => app.importData(ev.target.result);
            reader.readAsText(file);
        });

        // Init App
        window.onload = () => app.init();

    </script>
</body>
</html>

